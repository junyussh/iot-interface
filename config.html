<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Config</title>
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/tocas-ui/2.3.3/tocas.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tocas-ui/2.3.3/tocas.js"></script>
</head>
<style>
  .hidden {
    display: none;
  }

  .center {
    text-align: center;
  }
</style>

<body>
  <h1 class="ts center aligned header">
    Config
  </h1>
  <div class="ts divider"></div>
  <div class="ts narror container grid">
    <div class="four wide column"></div>

    <div class="eight wide column">
      <form class="ts center horizontal form">
        <div class="field">
          <div class="ts toggle checkbox">
            <input id="fastCharging" onchange="isChecked(this)" type="checkbox">
            <label for="fastCharging">啟用</label>
          </div>
        </div>
        <div class="hidden config">
          <div class="field">
            <label>MAC 位址</label>
            <input name="mac" type="text" disabled value="60:64:05:1B:79:21">
          </div>
          <div class="field">
            <label>使用者名稱</label>
            <input name="username" type="text">
          </div>
          <div class="field">
            <label>更新頻率(分)</label>
            <select>
              <option>10</option>
              <option>20</option>
              <option>30</option>
            </select>
          </div>
          <button onclick="save()" class="ts primary button">儲存</button>
        </div>
      </form>
    </div>
    <div class="four wide column"></div>
    <div class="ts modals dimmer">
      <dialog id="authorize" class="ts closable tiny modal">
        <div class="header">
          輸入使用者密碼
        </div>
        <div class="content">
          <form class="ts form">
            <div class="field">
              <label>請輸入您的密碼以授權更改</label>
              <input name="password" id="password" type="password">
            </div>
          </form>
        </div>
        <div class="actions">
          <button class="ts deny button">
            取消
          </button>
          <button class="ts positive button">
            確定
          </button>
        </div>
      </dialog>
    </div>
    <div class="ts modals dimmer">
      <dialog id="error" class="ts closable tiny modal">
        
      </dialog>
    </div>
    <div class="ts modals dimmer">
      <dialog id="success" class="ts closable tiny modal">
        
      </dialog>
    </div>
  </div>
  <script>
    const MAC = "60:64:05:1B:79:21";
    const URL = "http://localhost:8080/api";
    function ErrorModal(message) {
      var modal = `
      <div class="header">
          <i class="icon negative remove"></i> 失敗
        </div>
        <div class="content">
          <p>${message}</p>
        </div>
        <div class="actions">
          <button class="ts ok basic button">
            確定
          </button>
        </div>
      `
      document.querySelector("#error").innerHTML = modal;
    }
    function SuccessModal(message) {
      var modal = `
      <div class="header">
          <i class="icon positive checkmark"></i>成功
        </div>
        <div class="content">
          <p>${message}</p>
        </div>
        <div class="actions">
          <button class="ts ok basic button">
            確定
          </button>
        </div>
      `
      document.querySelector("#success").innerHTML = modal;
    }
    function isChecked(e) {
      if (e.checked) {
        document.querySelector("form > .config").classList.remove("hidden");
      } else {
        document.querySelector("form > .config").classList.add("hidden");
      }
    }
    function getValue(query) {
      var form = document.querySelector(query);
      var data = {};
      var item = form.querySelectorAll(
        "input[type='text'], input[type='password']"
      );
      item.forEach(e => {
        data[e.name] = e.value;
      });
      return data;
    }
    function activeDevice(token) {
      post({"mac": MAC}, "/device?token="+token).then((res) => {
        if(res.error) {
          ErrorModal("裝置已存在。");
          ts("#error").modal("show");
        } else {
          SuccessModal("裝置啟用成功！");
          ts("#success").modal("show");
        }
      })
    }
    function save() {
      var payload = getValue(".config");
      ts('#authorize').modal({
        onApprove: function () {
          var password = getValue("#authorize");
          payload = Object.assign(password, payload);
          document.querySelector("#password").value = ""
          post(payload, "/login").then((res) => {
            if (res.error) {
              ErrorModal("使用者名稱或密碼錯誤。")
              ts("#error").modal("show");
            } else {
              activeDevice(res.token);
            }
          })
        }
      }).modal("show");
    }
    function post(data, url) {
      return fetch(URL + url, {
        method: "POST",
        body: JSON.stringify(data),
        headers: {
          'Accept': 'application/json',
          "Content-Type": "application/json"
        }
      })
        .then(response => response.json())
    }
    document.querySelectorAll("form").forEach(function (e) {
      e.addEventListener("submit", function (event) {
        event.preventDefault();
      })
    });
  </script>
</body>

</html>